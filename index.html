<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Psychology Research Study</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link
      rel="shortcut icon"
      href="path/to/your/favicon.ico"
      type="image/x-icon"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Base Styles - Pejman's preference!*/
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Roboto", sans-serif;
      }

      body {
        background: url("https://raw.githubusercontent.com/arad1367/UniLi_sources/main/IMG/tim.jpg")
          no-repeat center center fixed;
        background-size: cover;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .container {
        width: 90%;
        max-width: 1000px; /* Change from 800px to 1000px */
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin: 40px auto;
        position: relative;
        overflow: hidden;
      }

      .section {
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .section.active {
        display: block;
        opacity: 1;
      }

      h1 {
        color: #2a6f62;
        text-align: center;
        margin-bottom: 20px;
        font-size: 28px;
      }

      h2 {
        color: #2a6f62;
        margin-bottom: 15px;
        font-size: 22px;
      }

      p {
        color: #333;
        line-height: 1.6;
        margin-bottom: 20px;
        font-size: 16px;
      }

      .btn {
        background-color: #9acbd0;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.3s;
        display: inline-block;
        margin: 10px 5px;
      }

      .btn:hover {
        background-color: #7fb0b5;
      }

      .btn-primary {
        background-color: #2a6f62;
      }

      .btn-primary:hover {
        background-color: #225a50;
      }

      .btn-secondary {
        background-color: #9acbd0;
      }

      .btn-secondary:hover {
        background-color: #7fb0b5;
      }

      .center-content {
        text-align: center;
      }

      .topic-selection {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin: 25px 0;
      }

      .topic-btn {
        padding: 15px 30px;
        font-size: 18px;
      }

      iframe {
        width: 100%;
        height: 600px;
        border: none;
        margin-bottom: 20px;
        min-width: 800px;
      }

      .timer {
        position: absolute;
        top: 15px;
        left: 15px;
        /* Changed from right: 15px to left: 15px - I think this is better!*/
        background-color: #2a6f62;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 14px;
        display: none;
      }

      .chatbot-container {
        width: 100%;
        height: 650px;
        display: none;
        margin: 0 auto;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 40px 0;
      }

      .loading-spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2a6f62;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .shiny-footer {
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        color: #2a6f62;
        font-size: 14px;
        font-weight: 500;
        border-top: 1px solid #9acbd0;
        background: linear-gradient(
          to right,
          rgba(255, 255, 255, 0.9),
          rgba(154, 203, 208, 0.2),
          rgba(255, 255, 255, 0.9)
        );
        border-radius: 0 0 15px 15px;
        animation: shimmering 3s infinite alternate;
        transition: all 0.3s ease;
      }

      .shiny-footer:hover {
        background: linear-gradient(
          to right,
          rgba(154, 203, 208, 0.2),
          rgba(255, 255, 255, 0.9),
          rgba(154, 203, 208, 0.2)
        );
        box-shadow: 0 0 10px rgba(154, 203, 208, 0.5);
      }

      @keyframes warning-pulse {
  0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
  100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
}

.warning-message {
  background-color: #ffebee; 
  border: 2px solid #f44336; 
  color: #d32f2f; 
  padding: 10px; 
  margin: 15px auto; 
  text-align: center; 
  border-radius: 5px; 
  max-width: 80%;
  animation: warning-pulse 2s infinite;
  transition: all 0.3s;
}

.warning-message:hover {
  background-color: #ffcdd2;
  transform: scale(1.02);
}

      @keyframes shimmering {
        0% {
          background-position: left;
        }

        100% {
          background-position: right;
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      /* Hide all Flowise elements when we're done - Note: 03.05.2025 */
      .flowise-hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        position: absolute !important;
        left: -9999px !important;
        top: -9999px !important;
        z-index: -9999 !important;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- New Section - Section 0: Prolific ID Entry - Currently best solution to ask once and use many times -->
      <div id="prolific-id-section" class="section active">
        <h1>Psychology Research Study</h1>
        <p>Please enter your Prolific ID:</p>
        <div class="center-content" style="margin: 30px auto">
          <input
            type="text"
            id="prolific-id-input"
            placeholder="Your Prolific ID"
            required
            style="
              padding: 12px;
              width: 300px;
              font-size: 16px;
              margin-bottom: 20px;
              border: 1px solid #9acbd0;
              border-radius: 5px;
            "
          />
          <br />
          <button id="prolific-id-btn" class="btn btn-primary">Continue</button>
        </div>
      </div>

      <!-- Section 1: Pre-Interaction Survey -->
      <div id="pre-survey-section" class="section">
        <h1>Psychology Research Study</h1>
        <iframe
          src="https://prettyform.addxt.com/a/form/vf/1FAIpQLSdu1IzR7oM-OLIIMKFIaOnjiz6zkeNjHehCl99OTqmCUF_LAg?width=700"
        ></iframe>
<div class="warning-message">
  <strong>Please ensure that you have clicked the "Submit" button on the Google Form. Once submitted, you may then click the button below.</strong>
</div>
        <div class="center-content" style="margin-top: 20px">
          <button id="pre-survey-completed-btn" class="btn btn-primary">
            I have completed the Pre-Interaction Survey and clicked the "Submit"
            button above.
          </button>
        </div>
      </div>

      <!-- Section 2: Therapy Type Selection -->
      <div id="therapy-selection-section" class="section">
        <h2>Thank you for completing the survey!</h2>
        <p>Now, please choose the type of advice that best suits you:</p>
        <div class="center-content">
          <button id="empathetic-btn" class="btn btn-secondary">
            Empathetic Advice
          </button>
          <button id="rational-btn" class="btn btn-secondary">
            Rational Advice
          </button>
        </div>
      </div>

      <!-- Section 3: Redirect Message -->
      <div id="redirect-section" class="section">
        <div class="loading">
          <div class="loading-spinner"></div>
          <h2 id="redirect-message"></h2>
        </div>
      </div>

      <!-- Section 4: Topic Selection - Updated 04.05.2025 -->
      <div id="topic-selection-section" class="section">
        <h2>
          Please select the topic that feels most relevant to you. The
          conversation will last 10 minutes.
        </h2>
        <div class="topic-selection">
          <button class="btn btn-secondary topic-btn" data-topic="anxiety">
            Anxiety
          </button>
          <button class="btn btn-secondary topic-btn" data-topic="depression">
            Depression
          </button>
          <button class="btn btn-secondary topic-btn" data-topic="stress">
            Stress
          </button>
        </div>
      </div>

      <!-- Section 5: Chatbot Interaction -->
      <div id="chatbot-section" class="section">
        <div class="timer" id="chat-timer">Time remaining: 5:00</div>
        <div id="chatbot-container" class="chatbot-container"></div>
      </div>

      <!-- Section 6: Post-Interaction Survey -->
    <div id="post-survey-section" class="section">
      <iframe src="https://prettyform.addxt.com/a/form/vf/1FAIpQLSeMFZHnFRaWgvfyKdpmnzgp0jUvSesswnYF7FCG6ZbbgTIYCw"></iframe>
<div class="warning-message">
  <strong>Please ensure that you have clicked the "Next" and then "Submit" button on the Google Form before completing this experiment.</strong>
</div>
    </div>

    <!-- Flowise Chatbot Embed Container -->
    <div id="flowise-embed-container"></div>

    <!-- JavaScript Part -- Can be customized more but i think that is simple and good now! -->
    <script>
      // DOM Elements
      const sections = {
        prolificID: document.getElementById("prolific-id-section"),
        presurvey: document.getElementById("pre-survey-section"),
        therapySelection: document.getElementById("therapy-selection-section"),
        redirect: document.getElementById("redirect-section"),
        topicSelection: document.getElementById("topic-selection-section"),
        chatbot: document.getElementById("chatbot-section"),
        postsurvey: document.getElementById("post-survey-section"),
      };

      const buttons = {
        prolificID: document.getElementById("prolific-id-btn"),
        presurveyCompleted: document.getElementById("pre-survey-completed-btn"),
        empathetic: document.getElementById("empathetic-btn"),
        rational: document.getElementById("rational-btn"),
        topics: document.querySelectorAll(".topic-btn"),
      };

      // No need to disable the button -- > Lynn's request
      buttons.presurveyCompleted.disabled = false;
      buttons.presurveyCompleted.style.opacity = "1";
      buttons.presurveyCompleted.style.cursor = "pointer";

      const redirectMessage = document.getElementById("redirect-message");
      const chatbotContainer = document.getElementById("chatbot-container");
      const chatTimer = document.getElementById("chat-timer");
      const flowiseContainer = document.getElementById(
        "flowise-embed-container"
      );

      // Variables - I added handling hidden fields : Lynn please check it with Johannes
      let selectedTherapyType = "";
      let selectedTopic = "";
      let isAI = false;
      let chatflowId = "";
      let timerInterval;
      let remainingSeconds = 600; // 10 minutes
      let currentChatbotScript = null;
      let cleanupObserver = null;
      let participantAdviceStyle = ""; // Will store "empathetic" or "rational" - PrettyFormDesigner
      let participantToldChatWith = ""; // Will store "human" or "AI" - PrettyFormDesigner
      let participantProblem = ""; // Will store "Anxiety", "Depression", or "Stress" - PrettyFormDesigner
      let participantProlificID = ""; // Will store the Prolific ID - PrettyFormDesigner

      // Constants - Chatbot IDs
const CHATBOT_IDS = {
  empathetic: "469fb4ad-c152-446e-b048-15b60e169417",
  rational: "8488723a-2d03-410a-9484-12b3bb16f9a0",
};

      // Utility Functions
      function showSection(sectionToShow) {
        Object.values(sections).forEach((section) => {
          section.classList.remove("active");
        });
        sectionToShow.classList.add("active");
        window.scrollTo(0, 0);
      }

      function randomBoolean() {
        const randomValue = Math.random();
        console.log("Random value generated:", randomValue);
        return randomValue >= 0.5;
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? "0" : ""}${secs}`;
      }

      // Create a blocking style that prevents any Flowise elements from appearing
      function createBlockingStyle() {
        const style = document.createElement("style");
        style.textContent = `
                /* Target any elements created by Flowise */
                body > div:not(.container):not(#flowise-embed-container),
                body > button,
                body > iframe,
                [class*="flowise"],
                [id*="flowise"],
                [class*="chatbot"],
                [id*="chatbot"],
                [class*="chat-"],
                [id*="chat-"],
                [style*="position: fixed"],
                [style*="z-index: 9999"],
                [style*="bottom: 20px"],
                [style*="right: 20px"] {
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                    pointer-events: none !important;
                    position: absolute !important;
                    z-index: -9999 !important;
                }
            `;
        return style;
      }

      // Timer & Session Management
      function startTimer() {
        chatTimer.style.display = "block";
        chatTimer.textContent = `Time remaining: ${formatTime(
          remainingSeconds
        )}`;
        let reminderShown = false; // Add this flag to track if reminder was shown

        timerInterval = setInterval(() => {
          remainingSeconds--;
          chatTimer.textContent = `Time remaining: ${formatTime(
            remainingSeconds
          )}`;

          // Show reminder when 1 minute is left - in main experiment 2 min left!
          if (remainingSeconds === 60 && !reminderShown) {
            alert(
              "One minute left â€” please wrap up any last questions or comments."
            );
            reminderShown = true; // Set flag to prevent showing reminder multiple times
          }

          if (remainingSeconds <= 0) {
            clearInterval(timerInterval);
            endChatSession(true); // Show alert
          }
        }, 1000);
      }

      function createOverlay() {
        // Create a full-screen overlay that sits at a high z-index
        const overlay = document.createElement("div");
        overlay.id = "chat-blocker-overlay";
        overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 100000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: 'Roboto', sans-serif;
    `;

        // Add a message to the overlay
        const message = document.createElement("h2");
        message.textContent = "Your chat session has ended.";
        message.style.cssText = "color: #2a6f62; margin-bottom: 15px;";
        overlay.appendChild(message);

        const subMessage = document.createElement("p");
        subMessage.textContent =
          "Please complete the post-interaction survey below.";
        subMessage.style.cssText = "color: #333; font-size: 16px;";
        overlay.appendChild(subMessage);

        return overlay;
      }

      function nukeFlowiseChat() {
        console.log("EXECUTING NUCLEAR OPTION TO DESTROY FLOWISE CHAT");

        // 1. Create and append a full-page blocking div with massive z-index
        const blocker = document.createElement("div");
        blocker.id = "absolute-chat-blocker";
        blocker.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: white;
        z-index: 999999999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: sans-serif;
    `;

        const blockerMessage = document.createElement("h2");
        blockerMessage.textContent = "Your chat session has ended";
        blockerMessage.style.color = "#2a6f62";
        blocker.appendChild(blockerMessage);

        document.body.appendChild(blocker);

        // 2. Destroy ALL iframes on the page - no exceptions 100% work :)
        document.querySelectorAll("iframe").forEach((iframe) => {
          iframe.src = "about:blank";
          iframe.remove();
        });

        // 3. Remove any script tags that might be powering Flowise
        document.querySelectorAll("script").forEach((script) => {
          if (
            script.src &&
            (script.src.includes("flowise") ||
              script.src.includes("chatbot") ||
              script.src.includes("cdn.jsdelivr.net"))
          ) {
            script.remove();
          }

          // If it's an inline script that mentions Flowise, ChatBot, etc.
          if (
            script.textContent &&
            (script.textContent.includes("flowise") ||
              script.textContent.includes("Chatbot") ||
              script.textContent.includes("chatbot") ||
              script.textContent.includes("chat-"))
          ) {
            script.textContent = ""; // Clear the script content ...
            script.remove();
          }
        });

        // 4. Apply super aggressive CSS - I checked this is work good
        const nukeStyle = document.createElement("style");
        nukeStyle.textContent = `
        /* Hide EVERYTHING except our container and blocker */
        body > *:not(.container):not(#absolute-chat-blocker),
        [class*="flowise"],
        [id*="flowise"],
        [class*="chatbot"],
        [id*="chatbot"],
        [class*="chat-"],
        [id*="chat-"],
        [style*="position: fixed"],
        [style*="z-index"],
        [style*="bottom"],
        [style*="right"],
        iframe,
        .chatbot-container,
        #chatbot-container,
        #chatbot-frame,
        #flowise-embed-container {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: absolute !important;
            z-index: -999999 !important;
            width: 0 !important;
            height: 0 !important;
            max-width: 0 !important;
            max-height: 0 !important;
            overflow: hidden !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Make sure our blocker stays visible */
        #absolute-chat-blocker {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 999999999 !important;
            width: 100vw !important;
            height: 100vh !important;
        }
    `;
        document.head.appendChild(nukeStyle);

        // 5. Overwrite any global Flowise/chatbot objects
        try {
          window.Chatbot = null;
          window.flowise = null;
          window.flowiseChat = null;
          window.flowiseChatbot = null;
        } catch (e) {
          console.log("Error nullifying global objects:", e);
        }

        // 6. Intercept and cancel any network requests to Flowise domains -- I check this part again
        try {
          const originalFetch = window.fetch;
          window.fetch = function (url, options) {
            if (
              typeof url === "string" &&
              (url.includes("flowise") ||
                url.includes("flowiseai") ||
                url.includes("chatbot") ||
                url.includes("chatflow"))
            ) {
              console.log("Blocked fetch request to:", url);
              return Promise.reject(new Error("Request blocked"));
            }
            return originalFetch.apply(this, arguments);
          };

          const originalXHROpen = XMLHttpRequest.prototype.open;
          XMLHttpRequest.prototype.open = function (method, url) {
            if (
              typeof url === "string" &&
              (url.includes("flowise") ||
                url.includes("flowiseai") ||
                url.includes("chatbot") ||
                url.includes("chatflow"))
            ) {
              console.log("Blocked XHR request to:", url);
              this.abort();
              return;
            }
            return originalXHROpen.apply(this, arguments);
          };
        } catch (e) {
          console.log("Error intercepting network requests:", e);
        }

        // 7. Return the blocker so we can remove it later if needed
        return blocker;
      }

      // endChatSession function :
      function endChatSession(showAlert = true) {
        // Clear timer
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        // Show alert
        if (showAlert) {
          alert(
            "Your chat session has ended. Please complete the post-interaction survey."
          );
        }

        // Update the post-survey iframe src to include our parameters
        const postSurveyIframe = document.querySelector(
          "#post-survey-section iframe"
        );
        if (postSurveyIframe) {
          let currentSrc = postSurveyIframe.src; // Define currentSrc

          // Add our parameters with the CORRECT entry IDs - Pejman's Solution with PrettyFormDesigner!
          if (currentSrc.includes("?")) {
            currentSrc += `&entry.1936250364=${encodeURIComponent(
              participantAdviceStyle
            )}&entry.273056075=${encodeURIComponent(participantToldChatWith)}`;
          } else {
            currentSrc += `?entry.1936250364=${encodeURIComponent(
              participantAdviceStyle
            )}&entry.273056075=${encodeURIComponent(participantToldChatWith)}`;
          }

          // Update the iframe src
          postSurveyIframe.src = currentSrc;
        }
        // Hide the chatbot section completely
        if (sections.chatbot) {
          sections.chatbot.style.display = "none";
        }

        // Show post survey section
        showSection(sections.postsurvey);

        // After showing the post-survey section, remove the blocker
        setTimeout(() => {
          if (blocker && blocker.parentNode) {
            blocker.parentNode.removeChild(blocker);
          }
        }, 1000);
      }

      // ENTIRELY NEW APPROACH TO CLEANING UP THE CHATBOT
      function endChatSession(showAlert = true) {
        // Clear timer
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        // Store our tracking data in sessionStorage
        sessionStorage.setItem("showPostSurvey", "true");
        sessionStorage.setItem(
          "participantAdviceStyle",
          participantAdviceStyle
        );
        sessionStorage.setItem(
          "participantToldChatWith",
          participantToldChatWith
        );
        sessionStorage.setItem("participantProblem", participantProblem);
        sessionStorage.setItem("participantProlificID", participantProlificID);

        // Show alert
        if (showAlert) {
          alert(
            "Your chat session has ended. The page will refresh to show the post-interaction survey."
          );
        }

        // Refresh the page - this will completely destroy the chatbot
        window.location.reload();
      }

      // initialization code
      document.addEventListener("DOMContentLoaded", function () {
        // If we have a Prolific ID stored but are not showing the post-survey,
        // skip the Prolific ID section and go straight to pre-survey
        if (
          sessionStorage.getItem("participantProlificID") &&
          !sessionStorage.getItem("showPostSurvey")
        ) {
          participantProlificID = sessionStorage.getItem(
            "participantProlificID"
          );
          console.log(
            "Retrieved Prolific ID from storage:",
            participantProlificID
          );

          // Update the pre-survey iframe with the stored Prolific ID
          const preIframe = document.querySelector(
            "#pre-survey-section iframe"
          );
          if (preIframe) {
            let preformSrc = preIframe.src;
            if (preformSrc.includes("?")) {
              preIframe.src =
                preformSrc +
                "&entry.1480597992=" +
                encodeURIComponent(participantProlificID);
            } else {
              preIframe.src =
                preformSrc +
                "?entry.1480597992=" +
                encodeURIComponent(participantProlificID);
            }
          }

          // Skip to pre-survey section
          showSection(sections.presurvey);
          return;
        }
        // Check if we need to show the post-survey section
        if (sessionStorage.getItem("showPostSurvey") === "true") {
          // Get our tracking data
          const storedAdviceStyle = sessionStorage.getItem(
            "participantAdviceStyle"
          );
          const storedToldChatWith = sessionStorage.getItem(
            "participantToldChatWith"
          );
          const storedProblem = sessionStorage.getItem("participantProblem");
          const storedProlificID = sessionStorage.getItem(
            "participantProlificID"
          );

          // Update our variables with stored values
          if (storedAdviceStyle) participantAdviceStyle = storedAdviceStyle;
          if (storedToldChatWith) participantToldChatWith = storedToldChatWith;
          if (storedProblem) participantProblem = storedProblem;
          if (storedProlificID) participantProlificID = storedProlificID;

          // Update the post-survey iframe src to include our parameters
          const postSurveyIframe = document.querySelector(
            "#post-survey-section iframe"
          );
          if (postSurveyIframe) {
            let currentSrc = postSurveyIframe.src; // Modified 10.05.2025
            if (currentSrc.includes("?")) {
              currentSrc += `&entry.1936250364=${encodeURIComponent(
                participantAdviceStyle
              )}&entry.273056075=${encodeURIComponent(
                participantToldChatWith
              )}&entry.1286249038=${encodeURIComponent(
                participantProblem
              )}&entry.976761536=${encodeURIComponent(participantProlificID)}`;
            } else {
              currentSrc += `?entry.1936250364=${encodeURIComponent(
                participantAdviceStyle
              )}&entry.273056075=${encodeURIComponent(
                participantToldChatWith
              )}&entry.1286249038=${encodeURIComponent(
                participantProblem
              )}&entry.976761536=${encodeURIComponent(participantProlificID)}`;
            }
            postSurveyIframe.src = currentSrc;
          }

          // Remove the flags from session storage - Modified 09.05.2025
          sessionStorage.removeItem("showPostSurvey");
          sessionStorage.removeItem("participantAdviceStyle");
          sessionStorage.removeItem("participantToldChatWith");
          sessionStorage.removeItem("participantProblem");
          sessionStorage.removeItem("participantProlificID");

          // Hide all sections and show only post-survey
          Object.values(sections).forEach((section) => {
            section.classList.remove("active");
          });
          sections.postsurvey.classList.add("active");
        }
      });

      // COMPLETELY REWRITTEN CHATBOT LOADING APPROACH
      function loadChatbot() {
        // First, clear any existing chatbot
        if (currentChatbotScript) {
          currentChatbotScript.remove();
        }

        // container is clean
        chatbotContainer.innerHTML = "";
        flowiseContainer.innerHTML = "";

        // Set up a container to load the chatbot in
        const chatbotFrame = document.createElement("div");
        chatbotFrame.id = "chatbot-frame";
        chatbotContainer.appendChild(chatbotFrame);

        // Create chatbot script with the correct ID
        console.log("Loading chatbot with ID:", chatflowId);

        // The script must be added to document.body, not to our container - Modified 09.05.2025
        currentChatbotScript = document.createElement("script");
        currentChatbotScript.type = "module";
        currentChatbotScript.textContent = `
    import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js"
    
    // Initialize the chatbot with the selected ID
    Chatbot.init({
        chatflowid: "${chatflowId}",
        apiHost: "https://flowise-lynn.onrender.com",
        theme: {
            button: {
                backgroundColor: '#9ACBD0',
                right: 20,
                bottom: 20,
                size: 48,
                dragAndDrop: true,
                iconColor: 'white',
                customIconSrc: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/google-messages.svg',
                autoWindowOpen: {
                    autoOpen: true,
                    openDelay: 2,
                    autoOpenOnMobile: false
                }
            },
            tooltip: {
                showTooltip: true,
                tooltipMessage: 'Chat with Therapist',
                tooltipBackgroundColor: '#9ACBD0',
                tooltipTextColor: 'white',
                tooltipFontSize: 16
            },
            customCSS: \`
                /* Hide "Powered by Flowise" footer */
                .chatbot-footer {
                    display: none !important;
                }
                
                /* Fix height to prevent touching ceiling */
                .chatbot-chat-view {
                    max-height: 550px !important;
                }
            \`,
            chatWindow: {
                showTitle: true,
                showAgentMessages: true,
                title: 'Therapy Chat',
                titleAvatarSrc: 'https://raw.githubusercontent.com/arad1367/UniLi_sources/main/IMG/phsyco.jpg',
                welcomeMessage: 'Hey there! How are you feeling today? I would appreciate if you could first type your Prolific ID again to keep record and check identity.',
                errorMessage: 'We are sorry, but an unexpected error has occurred. Please try again later.',
                backgroundColor: '#ffffff',
                backgroundImage: 'https://raw.githubusercontent.com/arad1367/UniLi_sources/main/IMG/tim.jpg',
                height: 550,
                width: 500,
                fontSize: 16,
                clearChatOnReload: false,
                sourceDocsTitle: 'Sources:',
                renderHTML: true,
                botMessage: {
                    backgroundColor: '#E8F5E9',
                    textColor: '#333333',
                    showAvatar: true,
                    avatarSrc: 'https://raw.githubusercontent.com/arad1367/UniLi_sources/main/IMG/psy.jpg'
                },
                userMessage: {
                    backgroundColor: '#E0E0E0',
                    textColor: '#333333',
                    showAvatar: true,
                    avatarSrc: 'https://raw.githubusercontent.com/zahidkhawaja/langchain-chat-nextjs/main/public/usericon.png'
                },
                textInput: {
                    placeholder: 'Type your message...',
                    backgroundColor: '#ffffff',
                    textColor: '#303235',
                    sendButtonColor: '#9ACBD0',
                    maxChars: 1000,
                    maxCharsWarningMessage: 'You exceeded the characters limit. Please input less than 500 characters.',
                    autoFocus: true,
                    sendMessageSound: true,
                    sendSoundLocation: 'send_message.mp3',
                    receiveMessageSound: true,
                    receiveSoundLocation: 'receive_message.mp3'
                },
                feedback: {
                    color: '#303235'
                },
                dateTimeToggle: {
                    date: true,
                    time: true
                },
                footer: {
                    textColor: '#303235',
                    text: '',
                    company: '',
                    companyLink: ''
                }
            }
        }
    });
  `;

        // Append the script to the body
        document.body.appendChild(currentChatbotScript);

        // Display the chat container
        chatbotContainer.style.display = "block";
      }

      // FIXED FUNCTION - Therapy Selection with proper randomization and complete message - Final version
      function handleTherapySelection() {
        // Store the participant's selected advice style
        participantAdviceStyle = selectedTherapyType;

        // Randomly determine if they'll be told they're chatting with AI or human
        // This is independent of their advice style selection
        const willTellAI = Math.random() >= 0.5; // 50% chance of getting AI (This problem is now solved!)
        participantToldChatWith = willTellAI ? "AI" : "human";

        // Always use the chatbot ID that matches their actual advice style selection - previous issue is addressed
        if (selectedTherapyType === "empathetic") {
          chatflowId = CHATBOT_IDS.empathetic;
          console.log("Selected EMPATHETIC chatbot with ID:", chatflowId);
        } else if (selectedTherapyType === "rational") {
          chatflowId = CHATBOT_IDS.rational;
          console.log("Selected RATIONAL chatbot with ID:", chatflowId);
        }

        // Now show the appropriate message based on what we're telling them (AI or human)
        if (participantToldChatWith === "AI") {
          redirectMessage.textContent =
            "Great choice! You will now interact with an AI therapist and will be redirected shortly.";
        } else {
          redirectMessage.textContent =
            "Great choice! You will now interact with a human therapist and will be redirected shortly.";
        }

        // Update the console with our tracking values
        console.log("Tracking data - Advice style:", participantAdviceStyle);
        console.log(
          "Tracking data - Told chatting with:",
          participantToldChatWith
        );

        showSection(sections.redirect);

        // Simulate loading time before showing topic selection
        setTimeout(() => {
          showSection(sections.topicSelection);
        }, 3000);
      }

      // Event Listeners
      buttons.presurveyCompleted.addEventListener("click", () => {
        showSection(sections.therapySelection);
      });

      buttons.empathetic.addEventListener("click", () => {
        selectedTherapyType = "empathetic";
        handleTherapySelection();
      });

      buttons.rational.addEventListener("click", () => {
        selectedTherapyType = "rational";
        handleTherapySelection();
      });

      buttons.topics.forEach((button) => {
        button.addEventListener("click", (e) => {
          selectedTopic = e.target.dataset.topic;
          participantProblem = e.target.textContent.trim(); // Store the topic text
          showSection(sections.chatbot);
          loadChatbot();
          startTimer();
        });
      });

      // Event listener for Prolific ID button
      buttons.prolificID.addEventListener("click", () => {
        // Get the Prolific ID
        const prolificInput = document.getElementById("prolific-id-input");

        if (prolificInput && prolificInput.value.trim()) {
          // Store the Prolific ID
          participantProlificID = prolificInput.value.trim();
          console.log("Prolific ID entered:", participantProlificID);

          // Store in sessionStorage for persistence
          sessionStorage.setItem(
            "participantProlificID",
            participantProlificID
          );

          // Update the pre-interaction survey URL with the Prolific ID
          const preIframe = document.querySelector(
            "#pre-survey-section iframe"
          );
          if (preIframe) {
            let preformSrc = preIframe.src;
            if (preformSrc.includes("?")) {
              preIframe.src =
                preformSrc +
                "&entry.1480597992=" +
                encodeURIComponent(participantProlificID);
            } else {
              preIframe.src =
                preformSrc +
                "?entry.1480597992=" +
                encodeURIComponent(participantProlificID);
            }
            console.log("Updated pre-interaction form URL:", preIframe.src);
          }

          // Move to the pre-survey section
          showSection(sections.presurvey);
        } else {
          // If no Prolific ID entered, show an alert
          alert("Please enter your Prolific ID to continue.");
        }
      });
    </script>
  </body>
</html>
